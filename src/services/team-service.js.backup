// src/services/team-service.js
// íŒ€ì› ê´€ë¦¬ ì„œë¹„ìŠ¤

const logger = require('../../logger');
const ConfigService = require('./config-service');
const configService = new ConfigService();
const messageService = require('./message-service');
const { getWeekKey, getCurrentKSTDate } = require('../utils/date-utils');

/**
 * ì½”ë“œ ë¦¬ë·° ì§ê¿ ë°°ì • ë° ì „ì†¡ (ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ) - ì±„ë„ë¡œ ì „ì†¡
 */
async function assignCodeReviewPairsAndSendMessage() {
    try {
        const config = configService.loadConfig();
        let teamMembers = config.teamMembers;

        logger.info('Starting code review pair assignment');
        logger.debug(`All team members: ${teamMembers.map(m => `${m.name}(${m.id})`).join(', ')}`);

        if (teamMembers.length < 2) {
            const message = "ğŸ‘¥ ì½”ë“œ ë¦¬ë·° ì§ê¿ ì•Œë¦¼ ğŸ‘¥\n\níŒ€ì›ì´ ë¶€ì¡±í•˜ì—¬ ì½”ë“œ ë¦¬ë·° ì§ê¿ì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            logger.warn('Insufficient team members for code review pair assignment');
            await messageService.sendChannelMessage(message);
            return;
        }

        // ì½”ë“œ ë¦¬ë·° íšŸìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ì ì€ ìˆœì„œëŒ€ë¡œ)
        teamMembers.sort((a, b) => (a.codeReviewCount || 0) - (b.codeReviewCount || 0));
        
        logger.info(`Team members sorted by code review count: ${teamMembers.map(m => `${m.name}(${m.codeReviewCount || 0})`).join(', ')}`);
        
        // ì§ê¿ ìƒì„±
        let pairs = [];
        let remainingMembers = [...teamMembers];

        while (remainingMembers.length >= 2) {
            if (remainingMembers.length === 3) {
                pairs.push(remainingMembers.splice(0, 3));
            } else {
                pairs.push(remainingMembers.splice(0, 2));
            }
        }

        logger.info(`Created ${pairs.length} code review pairs`);
        pairs.forEach((pair, index) => {
            const pairInfo = pair.map(member => `${member.name}(${member.id})`).join(' & ');
            logger.debug(`Pair ${index + 1}: ${pairInfo}`);
        });

        let message = "ğŸ‘¥ ì´ë²ˆ ì£¼ ì½”ë“œ ë¦¬ë·° ì§ê¿ ì•Œë¦¼ ğŸ‘¥\n\n";
        pairs.forEach((pair, index) => {
            const pairNames = pair.map(member => teamMembers.find(m => m.id === member.id)?.name || member.id);
            message += `${index + 1}. ${pairNames.join(' & ')}\n`;
            
            pair.forEach(member => {
                const teamMember = teamMembers.find(m => m.id === member.id);
                if (teamMember) {
                    teamMember.codeReviewCount = (teamMember.codeReviewCount || 0) + 1;
                }
            });
        });

        message += "\nğŸ’¡ ì½”ë“œ ë¦¬ë·° ê°€ì´ë“œ:\n";
        message += "- ì„œë¡œì˜ ì½”ë“œë¥¼ ì •ê¸°ì ìœ¼ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”\n";
        message += "- ê±´ì„¤ì ì¸ í”¼ë“œë°± ì œê³µ\n";
        message += "- ì½”ë“œ í’ˆì§ˆ í–¥ìƒì— ì§‘ì¤‘\n";
        message += "- í•™ìŠµê³¼ ì„±ì¥ì˜ ê¸°íšŒë¡œ í™œìš©";

        // ì§ê¿ ì •ë³´ ì €ì¥
        const codeReviewPairs = pairs.map((pair, index) => ({
            pairNumber: index + 1,
            members: pair.map(member => ({
                id: member.id,
                name: member.name
            })),
            weekKey: getWeekKey()
        }));

        configService.updateCodeReviewPairs(codeReviewPairs);
        configService.updateTeamMembers(teamMembers);
        
        logger.info(`Updated code review counts: ${teamMembers.map(m => `${m.name}(${m.codeReviewCount || 0})`).join(', ')}`);

        // ì±„ë„ë¡œ ì•Œë¦¼ ë°œì†¡
        await messageService.sendChannelMessage(message);
        logger.info('Code review pair notification sent successfully to channel');
    } catch (error) {
        logger.error(`Error in code review pair assignment: ${error.message}`, error);
    }
}

/**
 * ë…¸íŠ¸ë¶ ì§€ì°¸ ì•Œë¦¼ ë°°ì • ë° ì „ì†¡ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€ - ê°œë³„ ë°œì†¡)
 */
async function assignLaptopDutyAndSendMessage() {
    try {
        const config = configService.loadConfig();
        let teamMembers = config.teamMembers;

        const todayKST = getCurrentKSTDate().getDay();
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        logger.info(`Starting laptop duty assignment for ${dayNames[todayKST]} (day ${todayKST})`);
        logger.debug(`Current team members: ${teamMembers.map(m => `${m.name}(${m.id})`).join(', ')}`);
        
        let selectedPair = [];
        let message = "âš ï¸ ë…¸íŠ¸ë¶ ì§€ì°¸ ì•Œë¦¼ âš ï¸\n\nì˜¤ëŠ˜ ë…¸íŠ¸ë¶ ì§€ì°¸ ë‹¹ë²ˆì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n";

        if (todayKST === 5) { // ê¸ˆìš”ì¼
            logger.info('Processing Friday laptop duty assignment (weekend included)');
            const result = assignLaptopDutyPair(teamMembers, 'friday');
            selectedPair = result.selectedPair;
            message += result.message;
            
            // ê¸ˆìš”ì¼ ë‹¹ì§ìë¥¼ ì£¼ë§ìš©ìœ¼ë¡œ ì €ì¥
            configService.updateCurrentLaptopDutyPair(selectedPair);
            configService.updateTeamMembers(teamMembers);
            
            logger.info(`Friday assignment saved for weekend: ${selectedPair.join(' + ')}`);

        } else if (todayKST === 6 || todayKST === 0) { // í† ìš”ì¼ ë˜ëŠ” ì¼ìš”ì¼
            logger.info('Processing weekend laptop duty (using Friday assignment)');
            
            // ì €ì¥ëœ ê¸ˆìš”ì¼ ë‹¹ì§ì ì‚¬ìš©
            const savedPair = config.currentLaptopDutyPair;
            if (savedPair && savedPair.length >= 1) {
                selectedPair = savedPair;
                
                // íŒ€ì› ì •ë³´ë¡œ ë©”ì‹œì§€ ìƒì„±
                const memberNames = selectedPair.map(memberId => {
                    const member = teamMembers.find(m => m.id === memberId);
                    return member ? `${member.name} (${memberId})` : memberId;
                });
                
                message += memberNames.map(name => `- ${name}`).join('\n') + '\n';
                
                logger.info(`Weekend assignment: ${selectedPair.join(' + ')} (from Friday)`);
            } else {
                message = "âš ï¸ ë…¸íŠ¸ë¶ ì§€ì°¸ ì•Œë¦¼ âš ï¸\n\nê¸ˆìš”ì¼ ë‹¹ë²ˆ ì •ë³´ê°€ ì—†ì–´ ë‹¹ë²ˆì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n" +
                         "ê¸ˆìš”ì¼ì— ë‹¹ì§ìê°€ ë°°ì •ë˜ë©´ í† ìš”ì¼ê³¼ ì¼ìš”ì¼ì— ë™ì¼í•œ ë‹¹ì§ìê°€ ìë™ìœ¼ë¡œ ë°°ì •ë©ë‹ˆë‹¤.";
                selectedPair = [];
                logger.warn('No Friday assignment data available for weekend');
            }
            
            // ì£¼ë§ì—ëŠ” ë³„ë„ë¡œ ë‹¹ì§ íšŸìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¤ì§€ ì•ŠìŒ (ê¸ˆìš”ì¼ì—ë§Œ ì¦ê°€)

        } else if (todayKST === 6 || todayKST === 0) { // í† ìš”ì¼ ë˜ëŠ” ì¼ìš”ì¼
            logger.info('Processing weekend laptop duty (using Friday assignment)');
            
            // ì €ì¥ëœ ê¸ˆìš”ì¼ ë‹¹ì§ì ì‚¬ìš©
            const savedPair = config.currentLaptopDutyPair;
            if (savedPair && savedPair.length >= 1) {
                selectedPair = savedPair;
                
                // íŒ€ì› ì •ë³´ë¡œ ë©”ì‹œì§€ ìƒì„±
                const memberNames = selectedPair.map(memberId => {
                    const member = teamMembers.find(m => m.id === memberId);
                    return member ? `${member.name} (${memberId})` : memberId;
                });
                
                message += memberNames.map(name => `- ${name}`).join('\n') + '\n';
                
                logger.info(`Weekend assignment: ${selectedPair.join(' + ')} (from Friday)`);
            } else {
                message = "âš ï¸ ë…¸íŠ¸ë¶ ì§€ì°¸ ì•Œë¦¼ âš ï¸\n\nê¸ˆìš”ì¼ ë‹¹ë²ˆ ì •ë³´ê°€ ì—†ì–´ ë‹¹ë²ˆì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n" +
                         "ê¸ˆìš”ì¼ì— ë‹¹ì§ìê°€ ë°°ì •ë˜ë©´ í† ìš”ì¼ê³¼ ì¼ìš”ì¼ì— ë™ì¼í•œ ë‹¹ì§ìê°€ ìë™ìœ¼ë¡œ ë°°ì •ë©ë‹ˆë‹¤.";
                selectedPair = [];
                logger.warn('No Friday assignment data available for weekend');
            }
            
            // ì£¼ë§ì—ëŠ” ë³„ë„ë¡œ ë‹¹ì§ íšŸìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¤ì§€ ì•ŠìŒ (ê¸ˆìš”ì¼ì—ë§Œ ì¦ê°€)
        } else { // ì›”~ëª©ìš”ì¼
            logger.info('Processing weekday laptop duty assignment');
            const result = assignLaptopDutyPair(teamMembers, 'weekday');
            selectedPair = result.selectedPair;
            message += result.message;
            
            configService.updateCurrentLaptopDutyPair([]);
            configService.updateTeamMembers(teamMembers);
        }

        if (selectedPair.length > 0 || message.includes("ë¶€ì¡±")) {
            const recipients = teamMembers.map(m => m.id).join(',');
            logger.info(`Sending laptop duty notification to all team members: ${recipients}`);
            await messageService.sendMessagesToMultipleRecipients(message, recipients);
            logger.info('Laptop duty notification sent successfully');
        }
    } catch (error) {
        logger.error(`Error in laptop duty assignment: ${error.message}`, error);
    }
}

/**
 * ë…¸íŠ¸ë¶ ë‹¹ì§ ì§ ë°°ì • ë¡œì§
 * @param {Array} teamMembers - íŒ€ì› ë°°ì—´
 * @param {string} type - ë°°ì • íƒ€ì… ('friday', 'weekday')
 * @returns {Object} - ë°°ì • ê²°ê³¼ ê°ì²´
 */
function assignLaptopDutyPair(teamMembers, type) {
    // ê¶Œí•œì´ ìˆëŠ” íŒ€ì›ë“¤ë§Œ í•„í„°ë§
    const authorizedMembers = teamMembers.filter(member => member.isAuthorized);
    authorizedMembers.sort((a, b) => (a.laptopDutyCount || 0) - (b.laptopDutyCount || 0));
    const selectedAuthorized = authorizedMembers.length > 0 ? authorizedMembers[0] : null;

    // ë‘ ë²ˆì§¸ ì‚¬ëŒì€ ì²« ë²ˆì§¸ì™€ ë‹¤ë¥¸ ê¶Œí•œì ì„ íƒ
    let selectedOther = null;
    if (authorizedMembers.length > 1) {
        selectedOther = authorizedMembers[1];
    }

    let selectedPair = [];
    let message = "";

    if (selectedAuthorized && selectedOther) {
        selectedPair = [selectedAuthorized.id, selectedOther.id];
        teamMembers.find(m => m.id === selectedAuthorized.id).laptopDutyCount = (teamMembers.find(m => m.id === selectedAuthorized.id).laptopDutyCount || 0) + 1;
        teamMembers.find(m => m.id === selectedOther.id).laptopDutyCount = (teamMembers.find(m => m.id === selectedOther.id).laptopDutyCount || 0) + 1;
        message += `- ${teamMembers.find(m => m.id === selectedAuthorized.id).name} (${selectedAuthorized.id})\n`;
        message += `- ${teamMembers.find(m => m.id === selectedOther.id).name} (${selectedOther.id})\n`;
        logger.info(`${type} assignment: ${selectedAuthorized.id} (authorized) + ${selectedOther.id} (authorized)`);
    } else if (authorizedMembers.length >= 1) {
        // ê¶Œí•œìê°€ 1ëª…ë§Œ ìˆëŠ” ê²½ìš°
        selectedPair = [selectedAuthorized.id];
        teamMembers.find(m => m.id === selectedAuthorized.id).laptopDutyCount = (teamMembers.find(m => m.id === selectedAuthorized.id).laptopDutyCount || 0) + 1;
        message += `- ${teamMembers.find(m => m.id === selectedAuthorized.id).name} (${selectedAuthorized.id})\n`;
        logger.info(`${type} assignment: ${selectedAuthorized.id} (authorized only)`);
    } else {
        message = "âš ï¸ ë…¸íŠ¸ë¶ ì§€ì°¸ ì•Œë¦¼ âš ï¸\n\nê¶Œí•œ íŒ€ì›ì´ ë¶€ì¡±í•˜ì—¬ ë…¸íŠ¸ë¶ ë‹¹ë²ˆì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        selectedPair = [];
        logger.warn(`Insufficient authorized team members for ${type} laptop duty assignment`);
    }

    return { selectedPair, message };
}

/**
 * íŒ€ì› í†µê³„ ì •ë³´ ì¡°íšŒ
 * @returns {Object} - íŒ€ì› í†µê³„ ì •ë³´
 */
function getTeamMemberStats() {
    try {
        const config = configService.loadConfig();
        const stats = {
            totalMembers: config.teamMembers.length,
            authorizedMembers: config.teamMembers.filter(m => m.isAuthorized).length,
            regularMembers: config.teamMembers.filter(m => !m.isAuthorized).length,
            dutyStats: config.teamMembers.map(m => ({
                id: m.id,
                name: m.name,
                laptopDutyCount: m.laptopDutyCount || 0,
                codeReviewCount: m.codeReviewCount || 0
            }))
        };
        
        return stats;
    } catch (error) {
        logger.error(`Error getting team member stats: ${error.message}`, error);
        return null;
    }
}

/**
 * íŒ€ì› ë‹¹ì§ íšŸìˆ˜ ì´ˆê¸°í™”
 */
function resetTeamMemberCounts() {
    try {
        const config = configService.loadConfig();
        config.teamMembers.forEach(member => {
            member.laptopDutyCount = 0;
            member.codeReviewCount = 0;
        });
        
        configService.updateTeamMembers(config.teamMembers);
        logger.info('Team member counts reset successfully');
        
        return { success: true, message: 'íŒ€ì› ë‹¹ì§ íšŸìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' };
    } catch (error) {
        logger.error(`Error resetting team member counts: ${error.message}`, error);
        return { success: false, message: 'íŒ€ì› ë‹¹ì§ íšŸìˆ˜ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' };
    }
}

/**
 * ì½”ë“œ ë¦¬ë·° ì§ê¿ í¸ì„± ë¯¸ë¦¬ë³´ê¸° ìƒì„±
 * @returns {Object} - ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°
 */
function generateCodeReviewPreview() {
    try {
        const config = configService.loadConfig();
        let teamMembers = [...config.teamMembers]; // ë³µì‚¬ë³¸ ìƒì„±

        logger.info('Generating code review pair preview');
        logger.debug(`All team members: ${teamMembers.map(m => `${m.name}(${m.id})`).join(', ')}`);

        if (teamMembers.length < 2) {
            return {
                success: false,
                message: 'íŒ€ì›ì´ ë¶€ì¡±í•˜ì—¬ ì½”ë“œ ë¦¬ë·° ì§ê¿ì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            };
        }

        // ì½”ë“œ ë¦¬ë·° íšŸìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ì ì€ ìˆœì„œëŒ€ë¡œ)
        teamMembers.sort((a, b) => (a.codeReviewCount || 0) - (b.codeReviewCount || 0));
        
        logger.info(`Team members sorted by code review count: ${teamMembers.map(m => `${m.name}(${m.codeReviewCount || 0})`).join(', ')}`);
        
        // ì§ê¿ ìƒì„± ì‹œë®¬ë ˆì´ì…˜
        let pairs = [];
        let remainingMembers = [...teamMembers];

        while (remainingMembers.length >= 2) {
            if (remainingMembers.length === 3) {
                pairs.push(remainingMembers.splice(0, 3));
            } else {
                pairs.push(remainingMembers.splice(0, 2));
            }
        }

        logger.info(`Generated ${pairs.length} code review pairs for preview`);
        pairs.forEach((pair, index) => {
            const pairInfo = pair.map(member => `${member.name}(${member.id})`).join(' & ');
            logger.debug(`Pair ${index + 1}: ${pairInfo}`);
        });

        // ë¯¸ë¦¬ë³´ê¸° ë©”ì‹œì§€ ìƒì„±
        let message = "ğŸ‘¥ ì´ë²ˆ ì£¼ ì½”ë“œ ë¦¬ë·° ì§ê¿ ì•Œë¦¼ ğŸ‘¥\n\n";
        pairs.forEach((pair, index) => {
            const pairNames = pair.map(member => member.name);
            message += `${index + 1}. ${pairNames.join(' & ')}\n`;
        });

        message += "\nğŸ’¡ ì½”ë“œ ë¦¬ë·° ê°€ì´ë“œ:\n";
        message += "- ì„œë¡œì˜ ì½”ë“œë¥¼ ì •ê¸°ì ìœ¼ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”\n";
        message += "- ê±´ì„¤ì ì¸ í”¼ë“œë°± ì œê³µ\n";
        message += "- ì½”ë“œ í’ˆì§ˆ í–¥ìƒì— ì§‘ì¤‘\n";
        message += "- í•™ìŠµê³¼ ì„±ì¥ì˜ ê¸°íšŒë¡œ í™œìš©";

        return {
            success: true,
            message: message,
            weekKey: getWeekKey(),
            pairs: pairs.map((pair, index) => ({
                pairNumber: index + 1,
                members: pair.map(member => ({
                    id: member.id,
                    name: member.name,
                    currentCount: member.codeReviewCount || 0
                }))
            }))
        };
        
    } catch (error) {
        logger.error(`Error generating code review preview: ${error.message}`, error);
        return {
            success: false,
            message: 'ì½”ë“œë¦¬ë·° ì§ê¿ í¸ì„± ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        };
    }
}

module.exports = {
    assignCodeReviewPairsAndSendMessage,
    assignLaptopDutyAndSendMessage,
    assignLaptopDutyPair,
    getTeamMemberStats,
    resetTeamMemberCounts,
    generateCodeReviewPreview
};
